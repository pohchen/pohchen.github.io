<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roast Chicken Game</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="./node_modules/web3/dist/web3.min.js"></script>
<script>
const Web3 = require('web3');
const roastChickenGameABI = YOUR_GENERATED_ABI; // Replace with the ABI of RoastChickenGame contract

const contractAddress = "YOUR_DEPLOYED_CONTRACT_ADDRESS"; // Replace with your deployed contract address
let web3, accounts, game;

async function approve() {
    const chickenTokenAddress = "YOUR_CHICKEN_TOKEN_CONTRACT_ADDRESS"; // Replace with your chicken token contract address
    const chickenToken = new web3.eth.Contract(ERC20_ABI, chickenTokenAddress);
    await chickenToken.methods.approve(contractAddress, APPROVE_AMOUNT.toString()).send({ from: accounts[0] });
    alert("Token approved for RoastChickenGame contract");
}
    
async function setupWeb3() {
    if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
            await window.ethereum.enable();
        } catch (error) {
            console.error("User denied access to Metamask");
            return;
        }
    } else {
        console.error("Please install Metamask");
        return;
    }

    accounts = await web3.eth.getAccounts();
    game = new web3.eth.Contract(roastChickenGameABI, contractAddress);
}

async function invest() {
    const chickens = parseInt(document.getElementById("chickenNum").value);
    const roastTimeHours = parseInt(document.getElementById("roastTimeHours").value);
    const cost = chickens * 1; // Calculate the actual cost in USDT based on your conversion rate

    await game.methods.invest(chickens, roastTimeHours).send({ from: accounts[0] });
    alert("Investment sent");
}
async function getStatus() {
    const player = await game.methods.players(accounts[0]).call();
    const canSteal = await canStealChickenFrom();

    const statusElement = document.getElementById("status");
    const canStealElement = document.getElementById("canSteal");

    statusElement.innerText = `Chickens: ${player.chickens}, Start time: ${new Date(player.startTime * 1000)}, Finish time: ${new Date(player.finishTime * 1000)}`;
    canStealElement.innerText = canSteal ? 'You can steal a chicken' : 'Cannot steal at the moment';
}

async function fetchGamePlayers() {
    const gamePlayersCount = await game.methods.gamePlayers().call();
    let gamePlayers = [];
    for (let i = 0; i < gamePlayersCount; i++) {
        const playerAddress = await game.methods.gamePlayers(i).call();
        gamePlayers.push(playerAddress);
    }
    return gamePlayers;
}

async function canStealChickenFrom() {
    // Assuming there's a list of players in the game, you'll have to fetch it based on your contract's logic
    const gamePlayers = await fetchGamePlayers();

    for (let i = 0; i < gamePlayers.length; i++) {
        const playerAddress = gamePlayers[i];
        if (playerAddress === accounts[0]) continue;

        const targetPlayer = await game.methods.players(playerAddress).call();

        if (block.timestamp >= targetPlayer.startTime &&
            block.timestamp <= targetPlayer.finishTime) {
            return true;
        }
    }

    return false;
}

    
</script>
</head>

<body>
<div class="container">
    <h1 class="text-center">Roast Chicken Game</h1>
    <button onclick="setupWeb3()" class="btn btn-primary btn-block">Connect to Metamask</button>
    <button id="approveButton" onclick="approve()" class="btn btn-primary btn-block">Approve Token Usage</button>
    <hr>
    <h2 class="text-center">Investment</h2>
    <div class="row">
        <div class="col">
            <label for="chickenNum">Number of Chickens:</label>
            <input type="number" id="chickenNum" name="chickenNum" class="form-control" min="10" placeholder="Min. 10" required>
        </div>
        <div class="col">
            <label for="roastTimeHours">Roast Time (Hours):</label>
            <input type="number" id="roastTimeHours" name="roastTimeHours" class="form-control" min="1" max="10" value="1" required>
        </div>
    </div>
    <button onclick="invest()" class="btn btn-success btn-block mt-2">Invest (Buy Chickens)</button>
    <hr>
    <h2 class="text-center">Game Actions</h2>
    <div class="row">
        <div class="col">
            <button class="btn btn-info btn-block">Harvest</button>
        </div>
        <div class="col">
            <button class="btn btn-danger btn-block">Steal</button>
        </div>
    </div>
</div>
<script>
    function updateStatus() {
        getStatus();
        setTimeout(updateStatus, 1000 * 60); // Refresh the status in every minute
    }
    window.onload = function() {
        updateStatus();
    };
</script>
</body>

</html>
